{% extends "base.html" %}

{% block title %}Batch Translation{% endblock %}

{% block content %}
<h1 class="text-center mb-4 glow-text fade-in-up">
    <i class="fas fa-layer-group me-2"></i>
    Batch PDF Translation
</h1>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card mb-4 card-hover-effect fade-in-up">
            <div class="card-body">
                <h5 class="card-title text-gradient">
                    <i class="fas fa-cloud-upload-alt me-2"></i>
                    Upload Multiple PDFs
                </h5>
                
                <form id="batchForm" class="needs-validation" novalidate>
                    <div class="mb-3">
                        <label for="sourceLang" class="form-label">Source Language</label>
                        <select class="form-select" id="sourceLang" required>
                            <option value="auto" selected>Auto-detect for each file</option>
                            {% for lang_name, lang_code in languages.items() %}
                                <option value="{{ lang_code }}">{{ lang_name.title() }} (all files)</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="pdfFiles" class="form-label">Choose PDF Files</label>
                        <input class="form-control" type="file" id="pdfFiles" accept=".pdf" multiple required>
                        <div class="form-text">You can select multiple PDF files at once.</div>
                        <div class="invalid-feedback">Please select at least one PDF file.</div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload me-2"></i>
                        Start Batch Translation
                    </button>
                </form>
            </div>
        </div>

        <div id="progressSection" class="card d-none mb-4 card-hover-effect fade-in">
            <div class="card-body">
                <h5 class="card-title text-gradient">
                    <i class="fas fa-tasks me-2"></i>
                    Translation Progress
                </h5>
                <div class="progress mb-3">
                    <div id="overallProgress" class="progress-bar bg-info" role="progressbar" style="width: 0%;">0%</div>
                </div>
                <div id="fileProgress"></div>
            </div>
        </div>

        <div id="resultsSection" class="card d-none card-hover-effect fade-in">
            <div class="card-body">
                <h5 class="card-title text-gradient">
                    <i class="fas fa-check-circle me-2"></i>
                    Completed Translations
                </h5>
                <div id="resultsList"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js" crossorigin="anonymous"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("batchForm");
    const socket = io();
    const activeTasks = new Map();
    let completedTasks = 0;
    let totalTasks = 0;
    let statusPollingInterval = null;
    let socketConnected = false;
    
    // Track socket connection
    socket.on('connect', function() {
        console.log('Socket connected');
        socketConnected = true;
    });
    
    socket.on('disconnect', function() {
        console.log('Socket disconnected');
        socketConnected = false;
    });

    form.addEventListener("submit", function (event) {
        event.preventDefault();
        if (!form.checkValidity()) {
            form.classList.add("was-validated");
            return;
        }

        const files = document.getElementById("pdfFiles").files;
        const sourceLang = document.getElementById("sourceLang").value;

        if (files.length === 0) {
            alert("Please select at least one PDF file.");
            return;
        }

        completedTasks = 0;
        totalTasks = files.length;
        activeTasks.clear();
        document.getElementById("progressSection").classList.remove("d-none");
        document.getElementById("resultsSection").classList.add("d-none");
        document.getElementById("fileProgress").innerHTML = "";
        document.getElementById("resultsList").innerHTML = "";

        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            formData.append("files[]", files[i]);
        }
        formData.append("source_lang", sourceLang);

        fetch("{{ url_for('upload_file') }}", {
            method: "POST",
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.task_ids && data.task_ids.length) {
                data.task_ids.forEach((taskId, index) => {
                    const filename = files[index].name;
                    activeTasks.set(taskId, { filename, status: "queued" });

                    const progressItem = document.createElement("div");
                    progressItem.className = "mb-2";
                    progressItem.id = "progress-" + taskId;
                    progressItem.innerHTML = `
                        <div class="d-flex justify-content-between">
                            <span>${filename}</span>
                            <span class="badge bg-secondary">Queued</span>
                        </div>
                        <div class="progress progress-sm">
                            <div class="progress-bar" style="width: 0%;"></div>
                        </div>
                    `;
                    document.getElementById("fileProgress").appendChild(progressItem);
                });
                
                // Start polling as fallback if SocketIO doesn't work
                startStatusPolling();
            } else {
                alert("Upload failed: " + (data.error || "Unknown error."));
            }
        })
        .catch(error => {
            alert("An error occurred: " + error.message);
        });
    });

    
    // Polling fallback function
    function startStatusPolling() {
        console.log('Starting status polling fallback');
        if (statusPollingInterval) {
            clearInterval(statusPollingInterval);
        }
        
        statusPollingInterval = setInterval(() => {
            // Always poll as backup mechanism
            console.log('Polling for status updates');
            pollTaskStatuses();
        }, 3000); // Poll every 3 seconds
    }
    
    function pollTaskStatuses() {
        activeTasks.forEach(async (taskData, taskId) => {
            if (taskData.status === 'queued' || taskData.status === 'processing') {
                try {
                    const response = await fetch(`/status/${taskId}`);
                    const status = await response.json();
                    
                    if (status.status !== taskData.status) {
                        // Update task status
                        taskData.status = status.status;
                        activeTasks.set(taskId, taskData);
                        
                        // Simulate socket message
                        handleStatusUpdate({
                            task_id: taskId,
                            status: status.status,
                            download_url: status.download_url,
                            message: status.error
                        });
                    }
                } catch (error) {
                    console.error(`Failed to poll status for task ${taskId}:`, error);
                }
            }
        });
    }
    
    function handleStatusUpdate(msg) {
        const task = activeTasks.get(msg.task_id);
        if (!task) return;

        const progressItem = document.getElementById("progress-" + msg.task_id);
        if (!progressItem) return;

        const badge = progressItem.querySelector(".badge");
        const progressBar = progressItem.querySelector(".progress-bar");

        if (msg.status === "processing") {
            badge.textContent = "Processing";
            badge.className = "badge bg-warning";
            progressBar.style.width = "50%";
        } else if (msg.status === "completed") {
            badge.textContent = "Completed";
            badge.className = "badge bg-success";
            progressBar.style.width = "100%";
            progressBar.classList.add("bg-success");

            const resultItem = document.createElement("div");
            resultItem.className = "alert alert-success d-flex justify-content-between align-items-center mb-2";
            resultItem.innerHTML = `
                <span><i class="fas fa-file-pdf me-2"></i>${task.filename}</span>
                <a href="${msg.download_url}" class="btn btn-sm btn-outline-success">
                    <i class="fas fa-download me-1"></i>Download
                </a>
            `;
            document.getElementById("resultsList").appendChild(resultItem);
            document.getElementById("resultsSection").classList.remove("d-none");

            completedTasks++;
        } else if (msg.status === "failed") {
            badge.textContent = "Failed";
            badge.className = "badge bg-danger";
            progressBar.style.width = "100%";
            progressBar.classList.add("bg-danger");

            const errorItem = document.createElement("div");
            errorItem.className = "alert alert-danger mb-2";
            errorItem.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>${task.filename}</strong>: ${msg.message}
            `;
            document.getElementById("resultsList").appendChild(errorItem);
            document.getElementById("resultsSection").classList.remove("d-none");

            completedTasks++;
        }

        const percent = Math.round((completedTasks / totalTasks) * 100);
        const overallProgress = document.getElementById("overallProgress");
        overallProgress.style.width = percent + "%";
        overallProgress.textContent = percent + "%";

        if (completedTasks === totalTasks) {
            overallProgress.classList.add("bg-success");
            clearInterval(statusPollingInterval);
        }
    }
    
    // Use common handler for both SocketIO and polling
    socket.on("translation_status", handleStatusUpdate);
});
</script>
{% endblock %}
